<!--<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gantt Chart Generator</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Gantt Chart Generator</h1>
    <label labelfor="fileInput">Upload Excel File</label>
    <input type="file" id="fileInput" accept=".xlsx, .xls">
    <button id="generate-btn">Generate Gantt Chart</button>

    <script>
        $(document).ready(function() {
            $('#generate-btn').click(function() {
                $.post('/generate', function(response) {
                    alert(response.message);
                });
            });
        });
    </script>
</body>
</html>-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gantt Chart Generator</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

   
        
        
        <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}"> 
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
      
    
</head>
<body>
    <div id="hourglass" style="display: none;">
        <div class="spinner"></div>
    </div>
    <header>
        <div class="logo">Tufts Libraries</div> 
     </header>
     <div class="content">
    <h1>Gantt Chart Generator</h1>
    <!--<div>
            
        <label class="label" for="download">Download sample input file:</label>
        <a href="{{ url_for('static', filename='template.xlsx') }}">Download</a>
    </div>-->
        <!--<label for="label" style="width: 10%">Upload Excel File</label>-->
        <input type="text" id="label" placeholder="Enter project year label, e.g. 'FY25'">
        <button id="fetch-btn">Refresh Data</button>
           <!-- New Assignee Dropdown -->
           <label for="assignee-select">Select Assignee:</label>
           <select id="assignee-select">
               <option value="All">All</option>
               <option value="Michael J. Hemment">Michael J. Hemment</option>
               <option value="Henry Steele">Henry Steele</option>

         </select>
         <select id="level-select">
            <option value="initiative">Initiative</option>
            <option value="subtasks">Child Issues of Initiatives</option>
            

      </select>
         <div class="form-row" style="display: none;" id="download-container">
            <button type="button" id="download-btn">Download Result</button>
        </div>
         <!-- Explanation paragraph -->
         <div id="app-description"><p>
            This app allows you to visualize your projects for a given period of time by allowing you to stack projects that start before the end date of the previous, on the same line  </p><p>While most Gantt charts have a separate row for each project, this chart uses the y-axis, which is normally synonymous with separate projects, as continuous date ranges such that once one project ends, another can begin, on the same line if room for that project fits there. This allows you to see if you are arranging project start and end dates in the optimal way given bandwidth at given times, and adjust start and end dates in respones if that would make better use of your project time.
            </p><p>This instance of the Gantt Chart Generator connects to a JIRA instance for which if you install this app on our own system you will need to get a bearer access token and enter into the .env file.</p>

                <p>It looks for either project start and end dates, or target start and target end.   Since this is at a project level of granularlity, it is looking only for initiatives.</p>

                

<!--<p><strong>Download the template file above to see the format to upload your project file in.</strong>  This file can also be fed into the generator.</p>-->
            </div>

            <div id="output-wrapper">
                <img id="output" src="" />
            </div>
            
            
   <script>
$(document).ready(function () {
  $('#fetch-btn').click(function () {
    $('#hourglass').show();

    const label = $('#label').val();
    let assignee = $('#assignee-select').val();
    const level = $('#level-select').val();

    // If "All" is selected, build a comma-separated list of names
    if (assignee === 'All') {
      const names = [];
      $('#assignee-select option').each(function () {
        const v = $(this).val();
        if (v && v !== 'All') names.push(v);
      });
      // Keep existing server contract: a single string of names
      assignee = names.join('","');
    }

    $.ajax({
      url: '/process',
      type: 'POST',
      contentType: 'application/json',
      data: JSON.stringify({ label, assignee, level }),
      success: function (data) {
        // data should be { status: 'success', image_data: '...' }
        $('#hourglass').hide();

        if (data && data.status === 'success' && data.image_data) {
          $('#app-description').hide();
          $('#output').attr('src', 'data:image/png;base64,' + data.image_data).show();
          $('#download-container').show();

          $('#download-btn').off('click').on('click', function () {
            // Download the chart as PNG
            const byteCharacters = atob(data.image_data);
            const byteNumbers = Array.from({ length: byteCharacters.length }, (_, i) =>
              byteCharacters.charCodeAt(i)
            );
            const byteArray = new Uint8Array(byteNumbers);
            const blob = new Blob([byteArray], { type: 'image/png' });

            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'gantt_chart.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
          });
        } else {
          alert('Unexpected response from server.');
        }
      },
      error: function (jqXHR, textStatus, errorThrown) {
        $('#hourglass').hide();
        alert('Failed to fetch data: ' + (errorThrown || textStatus));
      }
    });
  });
});
</script>

</div>
</body>
</html>
